<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>refactor/array.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-action.html">action</a><ul class='methods'><li data-type='method'><a href="module-action.html#.add">add</a></li><li data-type='method'><a href="module-action.html#.addAsync">addAsync</a></li><li data-type='method'><a href="module-action.html#.move">move</a></li><li data-type='method'><a href="module-action.html#.moveAsync">moveAsync</a></li><li data-type='method'><a href="module-action.html#.remove">remove</a></li><li data-type='method'><a href="module-action.html#.removeAsync">removeAsync</a></li></ul></li><li><a href="module-app.html">app</a><ul class='methods'><li data-type='method'><a href="module-app.html#.getDeps">getDeps</a></li><li data-type='method'><a href="module-app.html#~getFeatureRoutes">getFeatureRoutes</a></li><li data-type='method'><a href="module-app.html#~getFeatures">getFeatures</a></li><li data-type='method'><a href="module-app.html#~getFeatureStructure">getFeatureStructure</a></li><li data-type='method'><a href="module-app.html#~getRootRoutePath">getRootRoutePath</a></li><li data-type='method'><a href="module-app.html#~getSrcFiles">getSrcFiles</a></li></ul></li><li><a href="module-component.html">component</a><ul class='methods'><li data-type='method'><a href="module-component.html#.add">add</a></li><li data-type='method'><a href="module-component.html#.remove">remove</a></li><li data-type='method'><a href="module-component.html#.remove">remove</a></li></ul></li><li><a href="module-constant.html">constant</a><ul class='methods'><li data-type='method'><a href="module-constant.html#.add">add</a></li><li data-type='method'><a href="module-constant.html#.remove">remove</a></li><li data-type='method'><a href="module-constant.html#.rename">rename</a></li></ul></li><li><a href="module-feature.html">feature</a><ul class='methods'><li data-type='method'><a href="module-feature.html#.add">add</a></li><li data-type='method'><a href="module-feature.html#.move">move</a></li><li data-type='method'><a href="module-feature.html#.remove">remove</a></li></ul></li><li><a href="module-refactor.html">refactor</a><ul class='methods'><li data-type='method'><a href="module-refactor.html#.addExportFrom">addExportFrom</a></li><li data-type='method'><a href="module-refactor.html#.addImportFrom">addImportFrom</a></li><li data-type='method'><a href="module-refactor.html#.addToArray">addToArray</a></li><li data-type='method'><a href="module-refactor.html#.removeFromArray">removeFromArray</a></li><li data-type='method'><a href="module-refactor.html#.renameClassName">renameClassName</a></li><li data-type='method'><a href="module-refactor.html#.renameFunctionName">renameFunctionName</a></li><li data-type='method'><a href="module-refactor.html#.renameIdentifier">renameIdentifier</a></li></ul></li><li><a href="module-rekit-core.html">rekit-core</a><ul class='methods'><li data-type='method'><a href="module-rekit-core.html#.addAction">addAction</a></li><li data-type='method'><a href="module-rekit-core.html#.addAsyncAction">addAsyncAction</a></li><li data-type='method'><a href="module-rekit-core.html#.addComponent">addComponent</a></li><li data-type='method'><a href="module-rekit-core.html#.addFeature">addFeature</a></li><li data-type='method'><a href="module-rekit-core.html#.handleCommand">handleCommand</a></li><li data-type='method'><a href="module-rekit-core.html#.moveAction">moveAction</a></li><li data-type='method'><a href="module-rekit-core.html#.moveAsyncAction">moveAsyncAction</a></li><li data-type='method'><a href="module-rekit-core.html#.moveComponent">moveComponent</a></li><li data-type='method'><a href="module-rekit-core.html#.moveFeature">moveFeature</a></li><li data-type='method'><a href="module-rekit-core.html#.removeAction">removeAction</a></li><li data-type='method'><a href="module-rekit-core.html#.removeAsyncAction">removeAsyncAction</a></li><li data-type='method'><a href="module-rekit-core.html#.removeComponent">removeComponent</a></li><li data-type='method'><a href="module-rekit-core.html#.removeFeature">removeFeature</a></li></ul></li><li><a href="module-style.html">style</a><ul class='methods'><li data-type='method'><a href="module-style.html#.add">add</a></li><li data-type='method'><a href="module-style.html#.remove">remove</a></li><li data-type='method'><a href="module-style.html#.remove">remove</a></li></ul></li><li><a href="module-template.html">template</a><ul class='methods'><li data-type='method'><a href="module-template.html#.generate">generate</a></li><li data-type='method'><a href="module-template.html#.readTemplate">readTemplate</a></li></ul></li><li><a href="module-test.html">test</a><ul class='methods'><li data-type='method'><a href="module-test.html#.add">add</a></li><li data-type='method'><a href="module-test.html#.addAction">addAction</a></li><li data-type='method'><a href="module-test.html#.move">move</a></li><li data-type='method'><a href="module-test.html#.moveAction">moveAction</a></li><li data-type='method'><a href="module-test.html#.remove">remove</a></li><li data-type='method'><a href="module-test.html#.removeAction">removeAction</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.joinPath">joinPath</a></li><li data-type='method'><a href="module-utils.html#.mapSrcFile">mapSrcFile</a></li><li data-type='method'><a href="module-utils.html#.setSilent">setSilent</a></li><li data-type='method'><a href="module-utils.html#~error">error</a></li><li data-type='method'><a href="module-utils.html#~fatalError">fatalError</a></li><li data-type='method'><a href="module-utils.html#~getActionType">getActionType</a></li><li data-type='method'><a href="module-utils.html#~getAsyncActionTypes">getAsyncActionTypes</a></li><li data-type='method'><a href="module-utils.html#~getFullPath">getFullPath</a></li><li data-type='method'><a href="module-utils.html#~getPkgJson">getPkgJson</a></li><li data-type='method'><a href="module-utils.html#~getProjectRoot">getProjectRoot</a></li><li data-type='method'><a href="module-utils.html#~getRelativePath">getRelativePath</a></li><li data-type='method'><a href="module-utils.html#~log">log</a></li><li data-type='method'><a href="module-utils.html#~setPkgJson">setPkgJson</a></li><li data-type='method'><a href="module-utils.html#~setProjectRoot">setProjectRoot</a></li><li data-type='method'><a href="module-utils.html#~warn">warn</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#nearestCharAfter">nearestCharAfter</a></li><li><a href="global.html#nearestCharBefore">nearestCharBefore</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">refactor/array.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const _ = require('lodash');
const traverse = require('babel-traverse').default;
const utils = require('../utils');
const vio = require('../vio');
const common = require('./common');

/**
 * Find the nearest char index before given index. skip white space strings
 * If not found, return -1
 * eg: nearestCharBefore(',', '1,    2, 3', 4) => 1
 * @param {string} char - Which char to find
 * @param {string} str - The string to to search.
 * @index {number} index - From which index start to find
 * @
**/
function nearestCharBefore(char, str, index) {
  // Find the nearest char index before given index. skip white space strings
  // If not found, return -1
  // eg: nearestCharBefore(',', '1,    2, 3', 4) => 1
  let i = index - 1;
  while (i >= 0) {
    if (str.charAt(i) === char) return i;
    if (!/\s/.test(str.charAt(i))) return -1;
    i -= 1;
  }
  return -1;
}

/**
 * Similar with nearestCharBefore, but find the char after the given index.
 * If not found, return -1
 * @param {string} char - Which char to find
 * @param {string} str - The string to to search.
 * @index {number} index - From which index start to find
 * @
**/
function nearestCharAfter(char, str, index) {
  // Find the nearest char index before given index. skip white space strings
  // If not found, return -1
  let i = index + 1;
  while (i &lt; str.length) {
    if (str.charAt(i) === char) return i;
    if (!/\s/.test(str.charAt(i))) return -1;
    i += 1;
  }
  return -1;
}

/**
 * Add an element to an array definition.
 * @param {object} node - The ast node of the array definition.
 * @param {string} code - The code to append to the array.
 * @alias module:refactor.addToArrayByNode
 * @
**/
function addToArrayByNode(node, code) {
  // node: the arr expression node
  // code: added as the last element of the array

  const multilines = node.loc.start.line !== node.loc.end.line;
  let insertPos = node.start + 1; // insert after '['

  if (node.elements.length) {
    const ele = _.last(node.elements);
    insertPos = ele.end;
  }

  let replacement;
  if (multilines) {
    const indent = _.repeat(' ', node.loc.end.column - 1);
    replacement = `\n${indent}  ${code}`;
    if (node.elements.length) {
      replacement = `,${replacement}`;
    } else {
      replacement = `${replacement},`;
    }
  } else {
    replacement = code;
    if (node.elements.length > 0) {
      replacement = `, ${code}`;
    }
  }
  return [{
    start: insertPos,
    end: insertPos,
    replacement,
  }];
}

/**
 * Remove an element from an array definition.
 * @param {object} node - The ast node of the array definition.
 * @param {object} eleNode - The ast node to be removed.
 * @alias module:refactor.removeFromArrayByNode
 * @
**/
function removeFromArrayByNode(node, eleNode) {
  const elements = node.elements;

  if (!elements.includes(eleNode)) {
    utils.warn('Failed to find element when trying to remove element from array.');
    return [];
  }

  if (!node._filePath) {
    utils.fatalError('No _filePath property found on node when removing element from array');
    return null;
  }

  const content = vio.getContent(node._filePath);
  let startPos = nearestCharBefore(',', content, eleNode.start);
  if (startPos &lt; 0) {
    // it's the first element
    startPos = node.start + 1;
  }

  let endPos = eleNode.end;

  if (elements.length === 1) {
    // if the element is the only element, try to remove the trailing comma if exists
    const nextComma = nearestCharAfter(',', content, endPos - 1);
    if (nextComma >= 0) endPos = nextComma + 1;
  }

  return [{
    start: startPos,
    end: endPos,
    replacement: '',
  }];
}

/**
 * Add an identifier to the array of the name 'varName'.
 * It only finds the first matched array in the top scope of ast.
 *
 * @param {object|string} ast - The ast tree or the js file path to find the array.
 * @param {string} varName - The variable name of the array definition.
 * @param {string} identifierName - The identifier to append to array.
 * @alias module:refactor.addToArray
 *
 * @example
 * const refactor = require('rekit-core').refactor;
 * // code in ast: const arr = [a, b, c];
 * refactor.addToArray(file, 'arr', 'd');
 * // code changes to: const arr = [a, b, c, d];
**/
function addToArray(ast, varName, identifierName) {
  let changes = [];
  traverse(ast, {
    VariableDeclarator(path) {
      const node = path.node;
      if (_.get(node, 'id.name') !== varName || _.get(node, 'init.type') !== 'ArrayExpression') return;
      node.init._filePath = ast._filePath;
      changes = addToArrayByNode(node.init, identifierName);
      path.stop();
    }
  });
  return changes;
}

/**
 * Remove an identifier from the array of the name 'varName'.
 * It only finds the first matched array in the global scope of ast.
 *
 * @param {object|string} ast - The ast tree or the js file path to find the array.
 * @param {string} varName - The variable name of the array definition.
 * @param {string} identifierName - The identifier to append to array.
 * @alias module:refactor.removeFromArray
 *
 * @example
 * const refactor = require('rekit-core').refactor;
 * // code in ast: const arr = [a, b, c];
 * refactor.removeFromArray(file, 'arr', 'a');
 * // code changes to: const arr = [b, c];
**/
function removeFromArray(ast, varName, identifierName) {
  let changes = [];
  traverse(ast, {
    VariableDeclarator(path) {
      const node = path.node;
      if (_.get(node, 'id.name') !== varName || _.get(node, 'init.type') !== 'ArrayExpression') return;
      node.init._filePath = ast._filePath;
      const toRemove = _.find(node.init.elements, ele => ele.name === identifierName);
      changes = removeFromArrayByNode(node.init, toRemove);
      path.stop();
    }
  });
  return changes;
}

module.exports = {
  nearestCharBefore, // export only for test purpose
  nearestCharAfter, // export only for test purpose
  addToArrayByNode,
  removeFromArrayByNode,
  addToArray: common.acceptFilePathForAst(addToArray),
  removeFromArray: common.acceptFilePathForAst(removeFromArray),
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Jul 09 2017 00:09:43 GMT+0800 (CST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
