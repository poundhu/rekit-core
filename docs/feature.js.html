<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>feature.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-action.html">action</a><ul class='methods'><li data-type='method'><a href="module-action.html#.add">add</a></li><li data-type='method'><a href="module-action.html#.addAsync">addAsync</a></li><li data-type='method'><a href="module-action.html#.move">move</a></li><li data-type='method'><a href="module-action.html#.moveAsync">moveAsync</a></li><li data-type='method'><a href="module-action.html#.remove">remove</a></li><li data-type='method'><a href="module-action.html#.removeAsync">removeAsync</a></li></ul></li><li><a href="module-app.html">app</a><ul class='methods'><li data-type='method'><a href="module-app.html#.getDeps">getDeps</a></li><li data-type='method'><a href="module-app.html#~getFeatureRoutes">getFeatureRoutes</a></li><li data-type='method'><a href="module-app.html#~getFeatures">getFeatures</a></li><li data-type='method'><a href="module-app.html#~getFeatureStructure">getFeatureStructure</a></li><li data-type='method'><a href="module-app.html#~getRootRoutePath">getRootRoutePath</a></li><li data-type='method'><a href="module-app.html#~getSrcFiles">getSrcFiles</a></li></ul></li><li><a href="module-component.html">component</a><ul class='methods'><li data-type='method'><a href="module-component.html#.add">add</a></li><li data-type='method'><a href="module-component.html#.remove">remove</a></li><li data-type='method'><a href="module-component.html#.remove">remove</a></li></ul></li><li><a href="module-constant.html">constant</a><ul class='methods'><li data-type='method'><a href="module-constant.html#.add">add</a></li><li data-type='method'><a href="module-constant.html#.remove">remove</a></li><li data-type='method'><a href="module-constant.html#.rename">rename</a></li></ul></li><li><a href="module-feature.html">feature</a><ul class='methods'><li data-type='method'><a href="module-feature.html#.add">add</a></li><li data-type='method'><a href="module-feature.html#.move">move</a></li><li data-type='method'><a href="module-feature.html#.remove">remove</a></li></ul></li><li><a href="module-refactor.html">refactor</a><ul class='methods'><li data-type='method'><a href="module-refactor.html#.addExportFrom">addExportFrom</a></li><li data-type='method'><a href="module-refactor.html#.addImportFrom">addImportFrom</a></li><li data-type='method'><a href="module-refactor.html#.addToArray">addToArray</a></li><li data-type='method'><a href="module-refactor.html#.removeFromArray">removeFromArray</a></li><li data-type='method'><a href="module-refactor.html#.renameClassName">renameClassName</a></li><li data-type='method'><a href="module-refactor.html#.renameFunctionName">renameFunctionName</a></li><li data-type='method'><a href="module-refactor.html#.renameIdentifier">renameIdentifier</a></li></ul></li><li><a href="module-rekit-core.html">rekit-core</a><ul class='methods'><li data-type='method'><a href="module-rekit-core.html#.addAction">addAction</a></li><li data-type='method'><a href="module-rekit-core.html#.addAsyncAction">addAsyncAction</a></li><li data-type='method'><a href="module-rekit-core.html#.addComponent">addComponent</a></li><li data-type='method'><a href="module-rekit-core.html#.addFeature">addFeature</a></li><li data-type='method'><a href="module-rekit-core.html#.handleCommand">handleCommand</a></li><li data-type='method'><a href="module-rekit-core.html#.moveAction">moveAction</a></li><li data-type='method'><a href="module-rekit-core.html#.moveAsyncAction">moveAsyncAction</a></li><li data-type='method'><a href="module-rekit-core.html#.moveComponent">moveComponent</a></li><li data-type='method'><a href="module-rekit-core.html#.moveFeature">moveFeature</a></li><li data-type='method'><a href="module-rekit-core.html#.removeAction">removeAction</a></li><li data-type='method'><a href="module-rekit-core.html#.removeAsyncAction">removeAsyncAction</a></li><li data-type='method'><a href="module-rekit-core.html#.removeComponent">removeComponent</a></li><li data-type='method'><a href="module-rekit-core.html#.removeFeature">removeFeature</a></li></ul></li><li><a href="module-style.html">style</a><ul class='methods'><li data-type='method'><a href="module-style.html#.add">add</a></li><li data-type='method'><a href="module-style.html#.remove">remove</a></li><li data-type='method'><a href="module-style.html#.remove">remove</a></li></ul></li><li><a href="module-template.html">template</a><ul class='methods'><li data-type='method'><a href="module-template.html#.generate">generate</a></li><li data-type='method'><a href="module-template.html#.readTemplate">readTemplate</a></li></ul></li><li><a href="module-test.html">test</a><ul class='methods'><li data-type='method'><a href="module-test.html#.add">add</a></li><li data-type='method'><a href="module-test.html#.addAction">addAction</a></li><li data-type='method'><a href="module-test.html#.move">move</a></li><li data-type='method'><a href="module-test.html#.moveAction">moveAction</a></li><li data-type='method'><a href="module-test.html#.remove">remove</a></li><li data-type='method'><a href="module-test.html#.removeAction">removeAction</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.joinPath">joinPath</a></li><li data-type='method'><a href="module-utils.html#.mapSrcFile">mapSrcFile</a></li><li data-type='method'><a href="module-utils.html#.setSilent">setSilent</a></li><li data-type='method'><a href="module-utils.html#~error">error</a></li><li data-type='method'><a href="module-utils.html#~fatalError">fatalError</a></li><li data-type='method'><a href="module-utils.html#~getActionType">getActionType</a></li><li data-type='method'><a href="module-utils.html#~getAsyncActionTypes">getAsyncActionTypes</a></li><li data-type='method'><a href="module-utils.html#~getFullPath">getFullPath</a></li><li data-type='method'><a href="module-utils.html#~getPkgJson">getPkgJson</a></li><li data-type='method'><a href="module-utils.html#~getProjectRoot">getProjectRoot</a></li><li data-type='method'><a href="module-utils.html#~getRelativePath">getRelativePath</a></li><li data-type='method'><a href="module-utils.html#~log">log</a></li><li data-type='method'><a href="module-utils.html#~setPkgJson">setPkgJson</a></li><li data-type='method'><a href="module-utils.html#~setProjectRoot">setProjectRoot</a></li><li data-type='method'><a href="module-utils.html#~warn">warn</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#nearestCharAfter">nearestCharAfter</a></li><li><a href="global.html#nearestCharBefore">nearestCharBefore</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">feature.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * Feature manager. It creates the basic feature folder structure and provides the capability to rename or remove it.
 * @module
**/

const path = require('path');
const _ = require('lodash');
const traverse = require('babel-traverse').default;
// const shell = require('shelljs');
const utils = require('./utils');
const vio = require('./vio');
const refactor = require('./refactor');
const constant = require('./constant');
const entry = require('./entry');
const template = require('./template');
const assert = require('./assert');

/**
 * Add a feature. Create the basic folder strcutre of a feature, such as files of `index.js`, `style.less`, `redux` folder, etc.
 * @param {string} name - feature name.
 * @alias module:feature.add
 *
 * @example &lt;caption>Create a feature&lt;/caption>
 * const feature = require('rekit-core').feature;
 * feature.add('customer'); // create a feature named 'customer'
 * // Result => Create a folder named 'customer' in 'src/features' folder.
**/
function add(name) {
  assert.notEmpty(name);
  name = _.kebabCase(name);
  assert.featureNotExist(name);
  const targetDir = utils.joinPath(utils.getProjectRoot(), `src/features/${name}`);

  // if (vio.dirExists(targetDir)) {
  //   utils.fatalError(`Feature already exists: ${name}`);
  // }

  vio.mkdir(targetDir);
  vio.mkdir(utils.joinPath(targetDir, 'redux'));
  vio.mkdir(utils.joinPath(utils.getProjectRoot(), 'tests/features', name));
  vio.mkdir(utils.joinPath(utils.getProjectRoot(), 'tests/features', name, 'redux'));

  // Create files from template
  [
    'index.js',
    'route.js',
    'style.' + utils.getCssExt(),
    'redux/actions.js',
    'redux/reducer.js',
    'redux/constants.js',
    'redux/initialState.js',
  ].forEach((fileName) => {
    template.generate(utils.joinPath(targetDir, fileName), {
      templateFile: fileName,
      context: { feature: name }
    });
  });

  // Create wrapper reducer for the feature
  template.generate(utils.joinPath(utils.getProjectRoot(), `tests/features/${name}/redux/reducer.test.js`), {
    templateFile: 'reducer.test.js',
    context: { feature: name }
  });
}

/**
 * Remove a feature
 * @param {string} name - feature name.
 * @alias module:feature.remove
**/
function remove(name) {
  vio.del(utils.joinPath(utils.getProjectRoot(), 'src/features', _.kebabCase(name)));
  vio.del(utils.joinPath(utils.getProjectRoot(), 'tests/features', _.kebabCase(name)));
}

/**
 * Rename a feature
 * @param {string} oldName - The old name.
 * @param {string} newName - The new name.
 * @alias module:feature.move
**/
function move(oldName, newName) {
  // Summary:
  //  Rename a feature. Seems a bit heavy operation.

  assert.notEmpty(oldName);
  assert.notEmpty(newName);
  assert.featureExist(oldName);
  assert.featureNotExist(newName);

  oldName = _.kebabCase(oldName);
  newName = _.kebabCase(newName);

  const prjRoot = utils.getProjectRoot();

  // Move feature folder
  const oldFolder = utils.joinPath(prjRoot, 'src/features', oldName);
  const newFolder = utils.joinPath(prjRoot, 'src/features', newName);
  vio.moveDir(oldFolder, newFolder);

  // Move feature test folder
  const oldTestFolder = utils.joinPath(prjRoot, 'tests/features', oldName);
  const newTestFolder = utils.joinPath(prjRoot, 'tests/features', newName);
  vio.moveDir(oldTestFolder, newTestFolder);

  // Update common/routeConfig
  entry.renameInRouteConfig(oldName, newName);

  // Update common/rootReducer
  entry.renameInRootReducer(oldName, newName);

  // Update styles/index.less
  entry.renameInRootStyle(oldName, newName);

  // Update feature/route.js for path and name if they bind to feature name
  refactor.updateFile(utils.mapFeatureFile(newName, 'route.js'), ast => [].concat(
    refactor.replaceStringLiteral(ast, _.kebabCase(oldName), _.kebabCase(newName)), // Rename path
    refactor.replaceStringLiteral(ast, _.upperFirst(_.lowerCase(oldName)), _.upperFirst(_.lowerCase(newName))) // Rename name
  ));

  // Try to rename css class names for components
  const folder = utils.joinPath(prjRoot, 'src/features', newName);
  vio.ls(folder)
    // It simply assumes component file name is pascal case
    .filter(f => /^[A-Z]/.test(path.basename(f)))
    .forEach((filePath) => {
      const moduleName = path.basename(filePath).split('.')[0];

      if (/\.js$/.test(filePath)) {
        // For components, update the css class name inside
        refactor.updateFile(filePath, ast => [].concat(
          refactor.replaceStringLiteral(ast, `${oldName}-${_.kebabCase(moduleName)}`, `${newName}-${_.kebabCase(moduleName)}`, false) // rename css class name
        ));
      } else if (/\.less$|\.scss$/.test(filePath)) {
        // For style update
        let lines = vio.getLines(filePath);
        const oldCssClass = `${oldName}-${_.kebabCase(moduleName)}`;
        const newCssClass = `${newName}-${_.kebabCase(moduleName)}`;

        lines = lines.map(line => line.replace(`.${oldCssClass}`, `.${newCssClass}`));
        vio.save(filePath, lines);
      }
    });

  // Rename action constants
  const reduxFolder = utils.joinPath(prjRoot, 'src/features', newName, 'redux');
  const constantsFile = utils.joinPath(reduxFolder, 'constants.js');
  const constants = [];
  traverse(vio.getAst(constantsFile), {
    VariableDeclarator(p) {
      const name = _.get(p, 'node.id.name');
      if (name &amp;&amp; _.startsWith(name, `${_.upperSnakeCase(oldName)}_`) &amp;&amp; name === _.get(p, 'node.init.value')) {
        constants.push(name);
      }
    }
  });

  constants.forEach((name) => {
    const oldConstant = name;
    const newConstant = name.replace(new RegExp(`^${_.upperSnakeCase(oldName)}`), _.upperSnakeCase(newName));
    constant.rename(newName, oldConstant, newConstant);
  });

  // Rename actions
  const reduxTestFolder = utils.joinPath(prjRoot, 'tests/features', newName, 'redux');
  vio.ls(reduxFolder)
  .concat(vio.ls(reduxTestFolder))
    // It simply assumes component file name is pascal case
    .forEach((filePath) => {
      if (/\.js$/.test(filePath)) {
        refactor.updateFile(filePath, (ast) => {
          let changes = [];
          constants.forEach((name) => {
            const oldConstant = name;
            const newConstant = name.replace(new RegExp(`^${_.upperSnakeCase(oldName)}`), _.upperSnakeCase(newName));
            changes = changes.concat(refactor.renameImportSpecifier(ast, oldConstant, newConstant));
          });
          return changes;
        });
      }
    });

  // Try to do a rougth string replacement based on the original generated code structure
  const testFolder = utils.joinPath(prjRoot, 'tests/features', newName);
  // const files = _.union(vio.ls(testFolder), vio.ls(utils.joinPath(testFolder, 'redux'))
  _.union(vio.ls(testFolder), vio.ls(utils.joinPath(testFolder, 'redux')))
    .filter(f => /\.test\.js$/.test(f))
    .forEach((filePath) => {
      const moduleName = path.basename(filePath).replace('.test.js', '');
      refactor.updateFile(filePath, ast => [].concat(
        refactor.replaceStringLiteral(ast, `src/features/${oldName}`, `src/features/${newName}`), // import module path
        refactor.replaceStringLiteral(ast, `../../../src/features/${oldName}'`, `../../../src/features/${newName}`), // import module path
        refactor.replaceStringLiteral(ast, `features/${oldName}/`, `features/${newName}/`, false), // import module path
        refactor.replaceStringLiteral(ast, `${oldName}/${moduleName}`, `${newName}/${moduleName}`), // describe component/page test
        refactor.replaceStringLiteral(ast, `${oldName}/redux/${moduleName}`, `${newName}/redux/${moduleName}`), // describe action test
        refactor.replaceStringLiteral(ast, `${oldName}/redux/reducer`, `${newName}/redux/reducer`), // describe reducer test
        refactor.replaceStringLiteral(ast, `${oldName}-${_.kebabCase(moduleName)}`, `${newName}-${_.kebabCase(moduleName)}`, false) // root css class name
      ));
    });
}

module.exports = {
  add,
  remove,
  move,
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Jul 09 2017 00:09:43 GMT+0800 (CST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
